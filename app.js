const STORE_KEY='epignosis_stream_v4_5_clean'; let state={categories:['All','Movies','Series','Documentaries','Kids','Faith & Inspiration','Educational & Science','Preaching & Teaching','Live TV & Worship','Parents & Families'],links:[{title:'VeggieTales — Official Uploads (Playlist)',url:'https://www.youtube.com/playlist?list=UUhddokv0fxIN3BS-KZpxFfA',category:'Kids',notes:'Kids playlist',tags:['kids','kids-playlist'],forceOpen:false},{title:'Superbook — English Full Episodes (Playlist)',url:'https://www.youtube.com/playlist?list=PLXQ1d1pW_6rF5oW0w0ZgXj6Gg1b3Q2y5j',category:'Kids',notes:'Kids playlist',tags:['kids','kids-playlist'],forceOpen:false},{title:'Saddleback Kids — Bible Stories (Playlist)',url:'https://www.youtube.com/playlist?list=PLcSt8Kz1AqG6X4hV7x0U6wZ1n1oTmQm3n',category:'Kids',notes:'Kids playlist',tags:['kids','kids-playlist'],forceOpen:false},{title:'BibleProject — How to Read the Bible (Playlist)',url:'https://www.youtube.com/playlist?list=PLH0Szn1yYNefO1w0DzF3LDeSYN9X0nXkM',category:'Educational & Science',notes:'Playlist',tags:['bible','education'],forceOpen:false},{title:'BibleProject — Book Overviews (Playlist)',url:'https://www.youtube.com/playlist?list=PLH0Szn1yYNefj1emIUhUj3N7XnDbhQ98S',category:'Educational & Science',notes:'Playlist',tags:['bible','education'],forceOpen:false},{title:'Grace to You — Sermons (Playlist)',url:'https://www.youtube.com/playlist?list=PLcpk0VtxTS7nJNmPR9U1FVLtZL1NVr7Di',category:'Preaching & Teaching',notes:'Playlist',tags:['sermons'],forceOpen:false},{title:'Shane & Shane — Worship (Playlist)',url:'https://www.youtube.com/playlist?list=PL_1UQ4KqF1IuD8-0oNqcsDGsH84oB9lnb',category:'Live TV & Worship',notes:'Playlist',tags:['worship'],forceOpen:false},{title:'Eternal Praise Christian Church — Livestreams',url:'https://www.youtube.com/@eternalpraisechristianchurch/streams',category:'Live TV & Worship',notes:'Opens on YouTube',tags:['live','church'],forceOpen:true},{title:'BYUtv — Family Shows (Official Site)',url:'https://www.byutv.org/',category:'Series',notes:'Opens official site',tags:['family','series'],forceOpen:true},{title:'GodTube — Christian Videos',url:'https://www.godtube.com/',category:'Faith & Inspiration',notes:'Opens official site',tags:['clips'],forceOpen:true},{title:'Shalom World — Live & On‑Demand',url:'https://shalomworld.org/',category:'Live TV & Worship',notes:'Opens official site',tags:['live'],forceOpen:true},{title:'FaithChannel — Movies, Kids, Sermons',url:'https://www.faithchannel.com/',category:'Faith & Inspiration',notes:'Opens official site',tags:['family'],forceOpen:true},{title:'RedeemTV — Free',url:'https://redeemtv.com/',category:'Movies',notes:'Opens official site',tags:['free'],forceOpen:true},{title:'CBN Family — Web',url:'https://www1.cbn.com/cbnfamily',category:'Faith & Inspiration',notes:'Opens official site',tags:[],forceOpen:true},{title:'Angel Studios — Watch',url:'https://www.angel.com/watch',category:'Movies',notes:'Opens official site',tags:['free'],forceOpen:true}],watchlist:[]};let storageOK=true;function save(){try{localStorage.setItem(STORE_KEY,JSON.stringify(state))}catch(e){storageOK=false;document.getElementById('storageWarning').classList.remove('hidden')}}function load(){try{const raw=localStorage.getItem(STORE_KEY);if(raw){state=JSON.parse(raw)}}catch(e){storageOK=false;document.getElementById('storageWarning').classList.remove('hidden')}}function backupDownload(){const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='epignosis_backup.json';a.click();URL.revokeObjectURL(url)}const isStandalone=(window.navigator.standalone===true)||window.matchMedia('(display-mode: standalone)').matches;function openExternal(url){if(isStandalone){location.href=url}else{window.location.href=url}}function openModal(id){document.getElementById('overlay').classList.remove('hidden');document.getElementById(id).classList.remove('hidden');document.body.style.overflow='hidden'}function closeModal(id){document.getElementById('overlay').classList.add('hidden');document.getElementById(id).classList.add('hidden');document.body.style.overflow=''}function parseYouTube(url){try{const u=new URL(url);const h=u.hostname.replace('www.','');if(!(h.includes('youtube.com')||h==='youtu.be'||h==='m.youtube.com'))return null;const list=u.searchParams.get('list');if(list)return{type:'playlist',id:list};if(h==='youtu.be'){const id=u.pathname.split('/').filter(Boolean)[0];if(id)return{type:'video',id}}if(u.pathname==='/watch'){const v=u.searchParams.get('v');if(v)return{type:'video',id:v}}return null}catch(e){return null}}function embedUrl(info){if(!info)return null;return info.type==='playlist'?`https://www.youtube.com/embed/videoseries?list=${info.id}&autoplay=1&rel=0`:`https://www.youtube.com/embed/${info.id}?autoplay=1&modestbranding=1&rel=0`}function initializeTabs(){const tabs=document.getElementById('tabs');tabs.innerHTML='';const cats=[...new Set(['All',...state.categories.filter(c=>c!=='All')])];cats.forEach((cat,i)=>{const b=document.createElement('button');b.textContent=cat;if(i===0)b.className='active';b.addEventListener('click',()=>renderCards(cat==='All'?null:cat));tabs.appendChild(b)})}function filteredLinks(category=null,query=''){let arr=[...state.links];if(category){arr=arr.filter(l=>l.category===category)}if(query){const q=query.toLowerCase();arr=arr.filter(l=>(l.title||'').toLowerCase().includes(q)||(l.notes||'').toLowerCase().includes(q)||(l.tags||[]).join(',').toLowerCase().includes(q)||(l.category||'').toLowerCase().includes(q))}return arr.sort((a,b)=>(a.title||'').localeCompare(b.title||''))}function renderCards(category=null){const cards=document.getElementById('cards');const query=document.getElementById('search').value.trim();const list=filteredLinks(category,query);[...document.querySelectorAll('.tabs button')].forEach(b=>b.classList.remove('active'));const label=category||'All';const active=[...document.querySelectorAll('.tabs button')].find(b=>b.textContent===label);if(active)active.classList.add('active');cards.innerHTML='';if(list.length===0){cards.innerHTML='<p class="muted" style="grid-column:1/-1;text-align:center">No results.</p>';return}list.forEach((item)=>{const ytInfo=(!item.forceOpen)?parseYouTube(item.url):null;const canEmbed=!!ytInfo;const card=document.createElement('article');card.className='card';card.innerHTML=`<h3>${item.title||'Untitled'}</h3><div class='meta'>${item.category||''} • ${(item.tags||[]).join(', ')}</div><p class='muted'>${item.notes||''}</p><div class='actions'>${canEmbed?`<button class='chip play'>Play</button>`:''}<button class='chip' data-act='open'>Open</button><button class='chip' data-act='fav'>Add to Watchlist</button><button class='chip' data-act='edit'>Edit</button><button class='chip' data-act='del'>Delete</button></div>`;if(canEmbed){card.querySelector('.play').addEventListener('click',()=>openPlayer(embedUrl(ytInfo)))}card.querySelector('[data-act="open"]').addEventListener('click',()=>openExternal(item.url));card.querySelector('[data-act="fav"]').addEventListener('click',()=>{state.watchlist.push({title:item.title,url:item.url,addedAt:Date.now()});save();alert('Added to watchlist!')});card.querySelector('[data-act="edit"]').addEventListener('click',()=>openForm(item));card.querySelector('[data-act="del"]').addEventListener('click',()=>{if(confirm('Delete this link?')){state.links=state.links.filter(l=>!(l.title===item.title&&l.url===item.url));save();renderCards(category)}});cards.appendChild(card)})}let editing=null;function openForm(existing=null){editing=existing;const catSel=document.getElementById('f_category');catSel.innerHTML='';const cats=[...new Set(state.categories.filter(Boolean))];cats.forEach(c=>{const opt=document.createElement('option');opt.value=c;opt.textContent=c;catSel.appendChild(opt)});document.getElementById('f_title').value=existing?(existing.title||''):'';document.getElementById('f_url').value=existing?(existing.url||''):'';document.getElementById('f_category').value=existing?(existing.category||cats[0]):(cats[0]||'');document.getElementById('f_notes').value=existing?(existing.notes||''):'';document.getElementById('f_tags').value=existing?(existing.tags||[]).join(', '):'';openModal('formModal')}function closeForm(){closeModal('formModal')}function saveForm(){const entry={title:document.getElementById('f_title').value.trim(),url:document.getElementById('f_url').value.trim(),category:document.getElementById('f_category').value,notes:document.getElementById('f_notes').value.trim(),tags:document.getElementById('f_tags').value.split(',').map(s=>s.trim()).filter(Boolean)};if(!entry.title||!entry.url){alert('Please enter a title and URL.');return}if(editing){const i=state.links.findIndex(l=>l.url===editing.url&&l.title===editing.title);if(i>-1)state.links[i]=entry}else{state.links.push(Object.assign({forceOpen:false},entry))}save();closeForm();renderCards()}function showWatchlist(){const wrap=document.getElementById('watchlistContainer');wrap.innerHTML='';if(!state.watchlist||state.watchlist.length===0){wrap.innerHTML='<p class="muted">Your watchlist is empty. Add items using “Add to Watchlist”.</p>'}else{const ul=document.createElement('ul');ul.style.listStyle='none';ul.style.padding='0';state.watchlist.slice().reverse().forEach(w=>{const li=document.createElement('li');li.style.marginBottom='10px';li.innerHTML=`<div class='card'><h3>${w.title||'Untitled'}</h3><div class='meta'>${new Date(w.addedAt||Date.now()).toLocaleString()}</div><div class='actions'><button class='chip' data-act='open'>Open</button><button class='chip' data-act='remove'>Remove</button></div></div>`;li.querySelector('[data-act="open"]').addEventListener('click',()=>openExternal(w.url));li.querySelector('[data-act="remove"]').addEventListener('click',()=>{state.watchlist=state.watchlist.filter(x=>!(x.title===w.title&&x.url===w.url&&x.addedAt===w.addedAt));save();showWatchlist()});ul.appendChild(li)});wrap.appendChild(ul)}openModal('watchlistModal')}function openPlayer(src){document.getElementById('playerWrap').innerHTML=`<iframe src="${src}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`;openModal('playerModal')}function closePlayer(){document.getElementById('playerWrap').innerHTML='';closeModal('playerModal')}function wireUI(){document.getElementById('addBtn').addEventListener('click',()=>openForm());document.getElementById('watchlistBtn').addEventListener('click',showWatchlist);document.getElementById('closeWatchlist').addEventListener('click',()=>closeModal('watchlistModal'));document.getElementById('closePlayer').addEventListener('click',closePlayer);document.getElementById('cancelForm').addEventListener('click',closeForm);document.getElementById('saveForm').addEventListener('click',saveForm);document.getElementById('kidsModeBtn').addEventListener('click',()=>{document.getElementById('search').value='kids';renderCards()});document.getElementById('kidsPlayAllBtn').addEventListener('click',()=>{const playlists=state.links.filter(l=>(l.tags||[]).includes('kids-playlist')&&!l.forceOpen);if(playlists.length===0){alert('No embeddable kids playlist found. Add a YouTube playlist (with ?list=...)');return}const info=parseYouTube(playlists[0].url);const src=info&&info.type==='playlist'?`https://www.youtube.com/embed/videoseries?list=${info.id}&autoplay=1&rel=0`:null;if(!src){alert('The first Kids playlist is not a valid YouTube playlist URL.');return}openPlayer(src)});document.getElementById('search').addEventListener('input',()=>{const active=document.querySelector('.tabs button.active');const cat=(active&&active.textContent!=='All')?active.textContent:null;renderCards(cat)});document.getElementById('exportBtn').addEventListener('click',()=>{const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='epignosis_stream_export.json';a.click();URL.revokeObjectURL(url)});document.getElementById('importBtn').addEventListener('click',()=>{const input=document.createElement('input');input.type='file';input.accept='application/json';input.onchange=async()=>{const file=input.files[0];if(!file)return;try{const text=await file.text();const imported=JSON.parse(text);if(imported.categories&&imported.links){state=imported;save();initializeTabs();renderCards();alert('Import successful!')}else{alert('Invalid file.')}}catch(e){alert('Failed to import: '+e.message)}};input.click()});document.getElementById('downloadBackup').addEventListener('click',backupDownload)}function boot(){load();initializeTabs();renderCards();wireUI()}boot();